<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ËßÜÈ¢ëÊí≠ÊîæÂô®</title>
    <link rel="stylesheet" href="https://fonts.loli.net/icon?family=Material+Icons">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --on-primary: #ffffff;
            --surface: #ffffff;
            --on-surface: #1e293b;
            --surface-variant: #f1f5f9;
            --on-surface-variant: #64748b;
            --background: #f8fafc;
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --transition: 250ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #818cf8;
                --primary-dark: #6366f1;
                --on-primary: #0f172a;
                --surface: #1e293b;
                --on-surface: #f1f5f9;
                --surface-variant: #334155;
                --on-surface-variant: #cbd5e1;
                --background: #0f172a;
            }
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--background);
            color: var(--on-surface);
            line-height: 1.6;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 64rem;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            flex: 1;
        }

        .card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            margin-bottom: 1rem;
            transition: all var(--transition);
        }

        .input-group {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .search-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid var(--surface-variant);
            border-radius: var(--radius-lg);
            background: var(--surface);
            color: var(--on-surface);
            font-size: 1rem;
            transition: all var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .button {
            background: var(--primary);
            color: var(--on-primary);
            border: none;
            border-radius: var(--radius-lg);
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-height: 44px;
            white-space: nowrap;
        }

        .button:hover {
            background: var(--primary-dark);
            box-shadow: var(--shadow-md);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .video-wrapper {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-lg);
            position: relative;
        }

        /* ÁΩëÈ°µÂÖ®Â±èÊ®°Âºè */
        .video-wrapper.webpage-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            max-width: 100vw;
            z-index: 9999;
            border-radius: 0;
            margin: 0;
            aspect-ratio: auto;
        }

        video {
            width: 100%;
            height: 100%;
            display: block;
        }

        .video-info h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .video-info p {
            color: var(--on-surface-variant);
            font-size: 0.875rem;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .control-btn {
            padding: 0.75rem;
            border: 2px solid var(--surface-variant);
            background: var(--surface);
            color: var(--on-surface);
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .control-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .control-btn.primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--on-primary);
            border-color: transparent;
        }

        .snackbar {
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--surface);
            color: var(--on-surface);
            padding: 1rem 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            transition: transform var(--transition);
            z-index: 10000;
            max-width: calc(100% - 2rem);
        }

        .snackbar.show {
            transform: translateX(-50%) translateY(0);
        }

        .snackbar.error {
            background: #ef4444;
            color: white;
        }

        .snackbar.success {
            background: #10b981;
            color: white;
        }

        .info-text {
            font-size: 0.75rem;
            color: var(--on-surface-variant);
            margin-top: 0.5rem;
        }

        .hidden {
            display: none !important;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            gap: 1rem;
            z-index: 100;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header h1 {
                font-size: 1.25rem;
            }

            .input-group {
                flex-direction: column;
            }

            .controls-grid {
                grid-template-columns: 1fr;
            }

            .card {
                padding: 1rem;
            }
        }
    </style>
    <script src="https://cdn.jsdmirror.com/npm/hls.js@latest"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span class="material-icons" style="font-size: 1.75rem; color: var(--primary);">play_circle_filled</span>ËßÜÈ¢ëÊí≠ÊîæÂô®</h1>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 1rem; font-size: 1rem;">üì∫ Âä†ËΩΩËßÜÈ¢ë</h3>
            <div class="input-group">
                <input type="text" class="search-input" id="videoUrl" placeholder="ËæìÂÖ•ËßÜÈ¢ëÂú∞ÂùÄÊàñ‰ΩøÁî® #url=..." />
                <button class="button" onclick="app.loadVideo()">Âä†ËΩΩ</button>
            </div>
            <div class="info-text">üí° ÊîØÊåÅ MP4„ÄÅWebM„ÄÅHLS(.m3u8) Á≠âÊ†ºÂºè | Êàñ‰ΩøÁî® #url=Âú∞ÂùÄ Ëá™Âä®Âä†ËΩΩ</div>
            <div id="progressBar" class="progress-bar hidden">
                <div id="progressFill" class="progress-fill"></div>
            </div>
        </div>

        <div class="video-wrapper" id="videoWrapper">
            <video id="videoPlayer" controls playsinline crossorigin="anonymous"></video>
            <div id="loadingOverlay" class="loading-overlay hidden">
                <div class="spinner"></div>
                <div id="loadingText">Âä†ËΩΩ‰∏≠...</div>
            </div>
        </div>

        <div class="card">
            <div class="video-info">
                <h2 id="videoTitle">ÂáÜÂ§áÂ∞±Áª™</h2>
                <p id="videoInfo">ËæìÂÖ•ËßÜÈ¢ëÂú∞ÂùÄÂºÄÂßãÊí≠Êîæ</p>
            </div>

            <div class="controls-grid">
                <button class="control-btn primary" onclick="app.toggleWebpageFullscreen()">
                    <span class="material-icons">fullscreen</span> ÁΩëÈ°µÂÖ®Â±è
                </button>
                <button class="control-btn" onclick="app.toggleNativeFullscreen()">
                    <span class="material-icons">fullscreen_exit</span> ÂéüÁîüÂÖ®Â±è
                </button>
                <button class="control-btn" onclick="app.toggleForcedLandscape()">
                    <span class="material-icons">landscape</span> Âº∫Âà∂Ê®™Â±è
                </button>
                <button class="control-btn" onclick="app.toggleForcedPortrait()">
                    <span class="material-icons">portrait</span> Âº∫Âà∂Á´ñÂ±è
                </button>
                <button class="control-btn" onclick="app.adjustPlaybackRate(0.5)">
                    <span class="material-icons">slow_motion_video</span> 0.5x
                </button>
                <button class="control-btn" onclick="app.adjustPlaybackRate(1)">
                    <span class="material-icons">play_arrow</span> 1x
                </button>
                <button class="control-btn" onclick="app.adjustPlaybackRate(1.5)">
                    <span class="material-icons">fast_forward</span> 1.5x
                </button>
                <button class="control-btn" onclick="app.adjustPlaybackRate(2)">
                    <span class="material-icons">fast_forward</span> 2x
                </button>
            </div>
        </div>
    </div>

    <div id="snackbar" class="snackbar"></div>

    <script>
        const app = {
            video: null,
            videoUrl: null,
            hlsInstance: null,
            videoWrapper: null,
            blobUrls: new Set(),
            
            isWebpageFullscreen: false,
            isForcedLandscape: false,
            isForcedPortrait: false,
            
            init() {
                this.video = document.getElementById('videoPlayer');
                this.videoUrl = document.getElementById('videoUrl');
                this.videoWrapper = document.getElementById('videoWrapper');
                
                this.loadVideoFromHash();
                window.addEventListener('hashchange', () => this.loadVideoFromHash());
                
                // ÈîÆÁõòÂø´Êç∑ÈîÆ
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'f' || e.key === 'F') {
                        e.preventDefault();
                        this.toggleWebpageFullscreen();
                    }
                    if (e.key === ' ' && e.target.tagName !== 'INPUT') {
                        e.preventDefault();
                        this.video.paused ? this.video.play() : this.video.pause();
                    }
                    if (e.key === 'Escape') {
                        if (this.isWebpageFullscreen) {
                            e.preventDefault();
                            this.exitWebpageFullscreen();
                        }
                        if (document.fullscreenElement) {
                            e.preventDefault();
                            this.exitNativeFullscreen();
                        }
                    }
                    if (e.key === 'l' || e.key === 'L') {
                        e.preventDefault();
                        this.toggleForcedLandscape();
                    }
                    if (e.key === 'p' || e.key === 'P') {
                        e.preventDefault();
                        this.toggleForcedPortrait();
                    }
                });

                // ËßÜÈ¢ë‰∫ã‰ª∂ÁõëÂê¨
                this.video.addEventListener('loadedmetadata', () => {
                    const duration = this.formatTime(this.video.duration);
                    document.getElementById('videoInfo').textContent = `Êó∂Èïø: ${duration} | ÂàÜËæ®Áéá: ${this.video.videoWidth}x${this.video.videoHeight}`;
                });

                this.video.addEventListener('error', (e) => {
                    this.hideLoading();
                    const error = this.video.error;
                    let message = 'Êí≠ÊîæÈîôËØØ';
                    if (error) {
                        switch(error.code) {
                            case 1: message = 'ËßÜÈ¢ëÂä†ËΩΩË¢´‰∏≠Ê≠¢'; break;
                            case 2: message = 'ÁΩëÁªúÈîôËØØ'; break;
                            case 3: message = 'Ëß£Á†ÅÈîôËØØ'; break;
                            case 4: message = 'ËßÜÈ¢ëÊ†ºÂºè‰∏çÊîØÊåÅ'; break;
                        }
                    }
                    this.showSnackbar(message, 'error');
                });

                // ÂÖ®Â±èÂèòÂåñÁõëÂê¨
                document.addEventListener('fullscreenchange', () => {
                    if (!document.fullscreenElement) {
                        this.showSnackbar('Â∑≤ÈÄÄÂá∫ÂéüÁîüÂÖ®Â±èÊ®°Âºè', 'success');
                    }
                });
            },

            loadVideoFromHash() {
                const hash = window.location.hash.substring(1);
                const params = new URLSearchParams(hash);
                const url = params.get('url');
                
                if (url) {
                    this.videoUrl.value = decodeURIComponent(url);
                    this.loadVideo();
                }
            },

            async loadVideo() {
                const url = this.videoUrl.value.trim();
                if (!url) {
                    this.showSnackbar('ËØ∑ËæìÂÖ•ËßÜÈ¢ëÂú∞ÂùÄ', 'error');
                    return;
                }

                this.cleanup();
                this.showLoading('Ê≠£Âú®Âä†ËΩΩËßÜÈ¢ë...');

                try {
                    if (url.toLowerCase().includes('.m3u8')) {
                        await this.loadHLS(url);
                    } else {
                        await this.loadNormalVideo(url);
                    }
                } catch (error) {
                    this.hideLoading();
                    this.showSnackbar('Âä†ËΩΩÂ§±Ë¥•: ' + error.message, 'error');
                }
            },

            async loadNormalVideo(url) {
                this.video.src = url;
                const ext = this.getFileExtension(url);
                
                document.getElementById('videoTitle').textContent = `${ext.toUpperCase()} ËßÜÈ¢ë`;
                
                try {
                    await this.video.play();
                    this.hideLoading();
                } catch (error) {
                    this.hideLoading();
                    if (error.name === 'NotAllowedError') {
                        this.showSnackbar('Ëá™Âä®Êí≠ÊîæË¢´ÈòªÊ≠¢ÔºåËØ∑ÁÇπÂáªÊí≠ÊîæÊåâÈíÆ', 'error');
                    } else {
                        throw error;
                    }
                }
            },

            async loadHLS(url) {
                if (Hls.isSupported()) {
                    this.hlsInstance = new Hls({
                        debug: false,
                        enableWorker: true,
                        lowLatencyMode: false,
                        backBufferLength: 90
                    });

                    this.hlsInstance.loadSource(url);
                    this.hlsInstance.attachMedia(this.video);

                    this.hlsInstance.on(Hls.Events.MANIFEST_PARSED, async (event, data) => {
                        document.getElementById('videoTitle').textContent = 'HLS ÊµÅÂ™í‰Ωì';
                        const levels = data.levels.length;
                        document.getElementById('videoInfo').textContent = `${levels} ‰∏™Ë¥®ÈáèÁ≠âÁ∫ßÂèØÁî®`;
                        
                        try {
                            await this.video.play();
                            this.hideLoading();
                        } catch (error) {
                            this.hideLoading();
                            if (error.name === 'NotAllowedError') {
                                this.showSnackbar('Ëá™Âä®Êí≠ÊîæË¢´ÈòªÊ≠¢ÔºåËØ∑ÁÇπÂáªÊí≠Êîæ', 'error');
                            }
                        }
                    });

                    this.hlsInstance.on(Hls.Events.ERROR, (event, data) => {
                        console.error('HLS Error:', data);
                        if (data.fatal) {
                            this.hideLoading();
                            switch(data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    this.showSnackbar('ÁΩëÁªúÈîôËØØÔºåÊ≠£Âú®Â∞ùËØïÊÅ¢Â§ç...', 'error');
                                    this.hlsInstance.startLoad();
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    this.showSnackbar('Â™í‰ΩìÈîôËØØÔºåÊ≠£Âú®Â∞ùËØïÊÅ¢Â§ç...', 'error');
                                    this.hlsInstance.recoverMediaError();
                                    break;
                                default:
                                    this.showSnackbar('Êó†Ê≥ïÊí≠ÊîæÊ≠§ËßÜÈ¢ë', 'error');
                                    break;
                            }
                        }
                    });

                } else if (this.video.canPlayType('application/vnd.apple.mpegurl')) {
                    this.video.src = url;
                    document.getElementById('videoTitle').textContent = 'HLS ÊµÅÂ™í‰Ωì';
                    
                    try {
                        await this.video.play();
                        this.hideLoading();
                    } catch (error) {
                        this.hideLoading();
                        if (error.name === 'NotAllowedError') {
                            this.showSnackbar('Ëá™Âä®Êí≠ÊîæË¢´ÈòªÊ≠¢', 'error');
                        }
                    }
                } else {
                    this.hideLoading();
                    this.showSnackbar('ÊµèËßàÂô®‰∏çÊîØÊåÅ HLS Êí≠Êîæ', 'error');
                }
            },

            toggleWebpageFullscreen() {
                if (!this.isWebpageFullscreen) {
                    this.enterWebpageFullscreen();
                } else {
                    this.exitWebpageFullscreen();
                }
            },

            enterWebpageFullscreen() {
                this.videoWrapper.classList.add('webpage-fullscreen');
                this.isWebpageFullscreen = true;
                this.showSnackbar('ËøõÂÖ•ÁΩëÈ°µÂÖ®Â±èÊ®°Âºè (Êåâ ESC Êàñ F ÈîÆÈÄÄÂá∫)', 'success');
                
                if (this.video.paused) {
                    this.video.play().catch(e => console.log('Ëá™Âä®Êí≠ÊîæË¢´ÈòªÊ≠¢'));
                }
            },

            exitWebpageFullscreen() {
                this.videoWrapper.classList.remove('webpage-fullscreen');
                this.isWebpageFullscreen = false;
                
                // ÈÄÄÂá∫Âº∫Âà∂Ê®™Á´ñÂ±è
                if (this.isForcedLandscape) {
                    this.exitForcedLandscape();
                }
                if (this.isForcedPortrait) {
                    this.exitForcedPortrait();
                }
                
                this.showSnackbar('Â∑≤ÈÄÄÂá∫ÁΩëÈ°µÂÖ®Â±èÊ®°Âºè', 'success');
            },

            toggleNativeFullscreen() {
                if (!document.fullscreenElement) {
                    this.enterNativeFullscreen();
                } else {
                    this.exitNativeFullscreen();
                }
            },

            enterNativeFullscreen() {
                if (this.videoWrapper.requestFullscreen) {
                    this.videoWrapper.requestFullscreen();
                } else if (this.videoWrapper.webkitRequestFullscreen) {
                    this.videoWrapper.webkitRequestFullscreen();
                } else if (this.videoWrapper.msRequestFullscreen) {
                    this.videoWrapper.msRequestFullscreen();
                }
                this.showSnackbar('ËøõÂÖ•ÂéüÁîüÂÖ®Â±èÊ®°Âºè (Êåâ ESC ÈîÆÈÄÄÂá∫)', 'success');
            },

            exitNativeFullscreen() {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            },

            toggleForcedLandscape() {

                if (this.isForcedLandscape) {
                    this.exitForcedLandscape();
                } else {
                    this.enterForcedLandscape();
                }
            },

            enterForcedLandscape() {
                if (this.isForcedPortrait) {
                    this.exitForcedPortrait();
                }

                this.videoWrapper.style.transform = 'translate(-50%, -50%) rotate(90deg)';
                this.videoWrapper.style.width = '100vh';
                this.videoWrapper.style.height = '100vw';
                this.videoWrapper.style.position = 'fixed';
                this.videoWrapper.style.top = '50%';
                this.videoWrapper.style.left = '50%';
                this.videoWrapper.style.zIndex = '10000';
                
                this.isForcedLandscape = true;
                this.showSnackbar('Â∑≤Âº∫Âà∂Ê®™Â±èÊòæÁ§∫ (ÁÇπÂáªÂº∫Âà∂Á´ñÂ±èÈÄÄÂá∫)', 'success');
            },

            exitForcedLandscape() {
                this.videoWrapper.style.transform = '';
                this.videoWrapper.style.width = '';
                this.videoWrapper.style.height = '';
                this.videoWrapper.style.position = '';
                this.videoWrapper.style.top = '';
                this.videoWrapper.style.left = '';
                this.videoWrapper.style.zIndex = '';
                
                this.isForcedLandscape = false;
                this.showSnackbar('Â∑≤ÈÄÄÂá∫Âº∫Âà∂Ê®™Â±èÊ®°Âºè', 'success');
            },

            toggleForcedPortrait() {
                if (this.isForcedPortrait) {
                    this.exitForcedPortrait();
                } else {
                    this.enterForcedPortrait();
                }
            },

            enterForcedPortrait() {
                if (this.isForcedLandscape) {
                    this.exitForcedLandscape();
                }

                this.videoWrapper.style.maxWidth = '400px';
                this.videoWrapper.style.margin = '0 auto';
                
                this.isForcedPortrait = true;
                this.showSnackbar('Â∑≤Âº∫Âà∂Á´ñÂ±èÊòæÁ§∫ (ÁÇπÂáªÂº∫Âà∂Ê®™Â±èÈÄÄÂá∫)', 'success');
            },

            exitForcedPortrait() {
                this.videoWrapper.style.maxWidth = '';
                this.videoWrapper.style.margin = '';
                
                this.isForcedPortrait = false;
                this.showSnackbar('Â∑≤ÈÄÄÂá∫Âº∫Âà∂Á´ñÂ±èÊ®°Âºè', 'success');
            },

            adjustPlaybackRate(rate) {
                this.video.playbackRate = rate;
                this.showSnackbar(`Êí≠ÊîæÈÄüÂ∫¶: ${rate}x`, 'success');
            },

            cleanup() {
                if (this.hlsInstance) {
                    this.hlsInstance.destroy();
                    this.hlsInstance = null;
                }

                this.blobUrls.forEach(url => URL.revokeObjectURL(url));
                this.blobUrls.clear();

                this.video.src = '';
                this.video.load();
            },

            showLoading(text) {
                const overlay = document.getElementById('loadingOverlay');
                const loadingText = document.getElementById('loadingText');
                loadingText.textContent = text;
                overlay.classList.remove('hidden');
            },

            hideLoading() {
                document.getElementById('loadingOverlay').classList.add('hidden');
            },

            showSnackbar(message, type = '') {
                const snackbar = document.getElementById('snackbar');
                snackbar.textContent = message;
                snackbar.className = 'snackbar ' + type + ' show';
                
                setTimeout(() => {
                    snackbar.classList.remove('show');
                }, 3000);
            },

            getFileExtension(url) {
                const parts = url.split('.');
                return parts.length > 1 ? parts[parts.length - 1].split('?')[0] : 'video';
            },

            formatTime(seconds) {
                if (isNaN(seconds)) return '00:00';
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = Math.floor(seconds % 60);
                
                if (h > 0) {
                    return `${h}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                }
                return `${m}:${String(s).padStart(2, '0')}`;
            }
        };

        window.addEventListener('load', () => app.init());
    </script>
</body>
</html>